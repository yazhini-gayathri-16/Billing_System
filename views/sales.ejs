<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sales Overview</title>
    <link rel="icon" href="/images/logo 3-square.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles/navbarstyle.css">
    <link rel="stylesheet" href="/styles/headerstyle.css">
    <style>
        body {
            font-family: 'Gowun Batang', serif;
            background-color: #D3E4CD;
            margin: 0;
            padding: 0;
        }

        .page-container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px 30px;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin: 0 0 6px 0;
        }

        .header-left p {
            font-size: 14px;
            color: #718096;
            margin: 0;
        }

        .period-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .period-selector label {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }

        .period-select {
            padding: 10px 36px 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Gowun Batang', serif;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            min-width: 140px;
        }

        .period-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .period-info {
            font-size: 12px;
            color: #718096;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .period-info i {
            color: #4CAF50;
        }

        /* Date Range Section */
        .date-range-section {
            display: none;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .date-range-section.active {
            display: flex;
        }

        .date-range-section input[type="date"] {
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Gowun Batang', serif;
            background: white;
        }

        .date-range-section input[type="date"]:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .date-range-section span {
            color: #718096;
            font-size: 14px;
        }

        .btn-apply {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-apply:hover {
            background: #45a049;
        }

        /* Key Metrics Section */
        .metrics-section {
            margin-bottom: 20px;
        }

        .metrics-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .metrics-header i {
            color: #4CAF50;
            font-size: 18px;
        }

        .metrics-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .metric-card.total-income::before { background: #4CAF50; }
        .metric-card.expenses::before { background: #ef4444; }
        .metric-card.services::before { background: #8b5cf6; }
        .metric-card.packages::before { background: #f59e0b; }
        .metric-card.products::before { background: #3b82f6; }
        .metric-card.membership::before { background: #ec4899; }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .metric-icon.total-income { background: #dcfce7; color: #4CAF50; }
        .metric-icon.expenses { background: #fee2e2; color: #ef4444; }
        .metric-icon.services { background: #ede9fe; color: #8b5cf6; }
        .metric-icon.packages { background: #fef3c7; color: #f59e0b; }
        .metric-icon.products { background: #dbeafe; color: #3b82f6; }
        .metric-icon.membership { background: #fce7f3; color: #ec4899; }

        .metric-label span {
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-decoration {
            width: 40px;
            height: 40px;
            opacity: 0.15;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
            font-size: 11px;
            color: #4CAF50;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .metric-change span {
            color: #718096;
        }

        /* Payment Summary Section */
        .summary-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .summary-header-left h2 {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
            margin: 0 0 4px 0;
        }

        .summary-header-left p {
            font-size: 13px;
            color: #718096;
            margin: 0;
        }

        .btn-export {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background: #4CAF50;
            color: white;
        }

        /* Summary Table */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            padding: 12px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-table th:not(:first-child) {
            text-align: center;
        }

        .summary-table th:last-child {
            text-align: right;
            background: #f0fdf4;
        }

        .summary-table td {
            padding: 12px 14px;
            font-size: 14px;
            color: #4a5568;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .summary-table td:not(:first-child) {
            text-align: center;
        }

        .summary-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #1a202c;
        }

        .summary-table tbody tr:hover {
            background: #f7fafc;
        }

        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Billing Type Cell */
        .billing-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .billing-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .billing-icon.service { background: #ede9fe; color: #8b5cf6; }
        .billing-icon.package { background: #fef3c7; color: #f59e0b; }
        .billing-icon.product { background: #dbeafe; color: #3b82f6; }
        .billing-icon.membership { background: #fce7f3; color: #ec4899; }

        .billing-type span {
            font-weight: 600;
            color: #1a202c;
        }

        /* Total Row */
        .total-row {
            background: #f7fafc;
        }

        .total-row td {
            font-weight: 700;
            color: #1a202c;
        }

        .total-row td:last-child {
            background: #dcfce7;
            color: #4CAF50;
            font-size: 15px;
        }

        .dash {
            color: #cbd5e0;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .page-container {
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                gap: 16px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-table {
                font-size: 12px;
            }

            .summary-table th,
            .summary-table td {
                padding: 10px 8px;
            }

            .billing-icon {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    <%- include('partials/second_navbar') %>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-left">
                <h1>Dashboard</h1>
                <p>Financial Overview & Payment Summary</p>
            </div>
            <div class="header-right">
                <div class="period-selector">
                    <label>Period:</label>
                    <select id="filterType" class="period-select" onchange="handleFilterChange()">
                        <option value="today">Today</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="period-info" id="periodInfo">
                    <i class="far fa-calendar-alt"></i>
                    <span id="periodDateRange"></span>
                </div>
                <div class="date-range-section" id="dateRangeSection">
                    <input type="date" id="fromDate">
                    <span>to</span>
                    <input type="date" id="toDate">
                    <button type="button" class="btn-apply" onclick="applyCustomFilter()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Key Metrics Section -->
        <div class="metrics-section">
            <div class="metrics-header">
                <i class="fas fa-chart-bar"></i>
                <h2>Key Metrics</h2>
            </div>
            <div class="metrics-grid">
                <!-- Total Income -->
                <div class="metric-card total-income">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon total-income">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <span>Total Income</span>
                        </div>
                    </div>
                    <p class="metric-value" id="totalIncome">₹<%= totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>

                <!-- Expenses -->
                <div class="metric-card expenses">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon expenses">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <span>Expenses</span>
                        </div>
                    </div>
                    <p class="metric-value" id="totalExpenses">₹<%= totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>

                <!-- Services -->
                <div class="metric-card services">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon services">
                                <i class="fas fa-cut"></i>
                            </div>
                            <span>Services</span>
                        </div>
                    </div>
                    <p class="metric-value" id="serviceIncome">₹<%= serviceIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                    <% if (totalIncome > 0) { %>
                        <div class="metric-change">
                            <i class="fas fa-arrow-trend-up"></i>
                            <%= Math.round((serviceIncome / totalIncome) * 100) %>% of income
                        </div>
                    <% } %>
                </div>

                <!-- Packages -->
                <div class="metric-card packages">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon packages">
                                <i class="fas fa-gift"></i>
                            </div>
                            <span>Packages</span>
                        </div>
                    </div>
                    <p class="metric-value" id="packageIncome">₹<%= packageIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>

                <!-- Products -->
                <div class="metric-card products">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon products">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <span>Products</span>
                        </div>
                    </div>
                    <p class="metric-value" id="productIncome">₹<%= totalIncomeProIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>

                <!-- Membership -->
                <div class="metric-card membership">
                    <div class="metric-header">
                        <div class="metric-label">
                            <div class="metric-icon membership">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <span>Membership</span>
                        </div>
                    </div>
                    <p class="metric-value" id="membershipIncome">₹<%= membershipIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                    <% if (totalIncome > 0 && membershipIncome > 0) { %>
                        <div class="metric-change">
                            <i class="fas fa-arrow-trend-up"></i>
                            <%= Math.round((membershipIncome / totalIncome) * 100) %>% of income
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Payment Summary Section -->
        <div class="summary-section">
            <div class="summary-header">
                <div class="summary-header-left">
                    <h2>Payment Summary</h2>
                    <p>Breakdown by billing type and payment method.</p>
                </div>
                <button class="btn-export" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>

            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Billing Type</th>
                        <th>UPI</th>
                        <th>Cash</th>
                        <th>Card</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="billing-type">
                                <div class="billing-icon service">
                                    <i class="fas fa-cut"></i>
                                </div>
                                <span>Service</span>
                            </div>
                        </td>
                        <td id="serviceUPI"><%- totalUPI > 0 ? '₹ ' + totalUPI.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="serviceCash"><%- totalCash > 0 ? '₹ ' + totalCash.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="serviceCard"><%- totalCard > 0 ? '₹ ' + totalCard.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="serviceTotal">₹ <%= serviceIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="billing-type">
                                <div class="billing-icon package">
                                    <i class="fas fa-gift"></i>
                                </div>
                                <span>Package</span>
                            </div>
                        </td>
                        <td id="packageUPI"><%- totalUPIP > 0 ? '₹ ' + totalUPIP.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="packageCash"><%- totalCashP > 0 ? '₹ ' + totalCashP.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="packageCard"><%- totalCardP > 0 ? '₹ ' + totalCardP.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="packageTotal">₹ <%= packageIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="billing-type">
                                <div class="billing-icon product">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <span>Products</span>
                            </div>
                        </td>
                        <td id="productUPI"><%- totalUPIPro > 0 ? '₹ ' + totalUPIPro.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="productCash"><%- totalCashPro > 0 ? '₹ ' + totalCashPro.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="productCard"><%- totalCardPro > 0 ? '₹ ' + totalCardPro.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="productTotal">₹ <%= totalIncomeProIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="billing-type">
                                <div class="billing-icon membership">
                                    <i class="fas fa-id-card"></i>
                                </div>
                                <span>Memberships</span>
                            </div>
                        </td>
                        <td id="membershipUPI"><%- totalUPIM > 0 ? '₹ ' + totalUPIM.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="membershipCash"><%- totalCashM > 0 ? '₹ ' + totalCashM.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="membershipCard"><%- totalCardM > 0 ? '₹ ' + totalCardM.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="dash">-</span>' %></td>
                        <td id="membershipTotal">₹ <%= membershipIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>Total</strong></td>
                        <td><strong id="totUPI">₹ <%= totUPI.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></strong></td>
                        <td><strong id="totCash">₹ <%= totCash.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></strong></td>
                        <td><strong id="totCard">₹ <%= totCard.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></strong></td>
                        <td><strong id="grandTotal">₹ <%= totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Format date for display
        function formatDateDisplay(date) {
            return String(date.getDate()).padStart(2, '0') + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   date.getFullYear();
        }

        // Update period info display
        function updatePeriodInfo(filterType, fromDate = null, toDate = null) {
            const periodDateRange = document.getElementById('periodDateRange');
            const today = new Date();
            let startDate, endDate;

            switch (filterType) {
                case 'today':
                    startDate = today;
                    endDate = today;
                    break;
                case 'weekly':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'yearly':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    if (fromDate && toDate) {
                        startDate = new Date(fromDate);
                        endDate = new Date(toDate);
                    }
                    break;
            }

            if (startDate && endDate) {
                if (startDate.toDateString() === endDate.toDateString()) {
                    periodDateRange.textContent = formatDateDisplay(startDate);
                } else {
                    periodDateRange.textContent = `${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;
                }
            }
        }

        // Initialize period info on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePeriodInfo('monthly');
        });

        // Handle filter type change
        function handleFilterChange() {
            const filterType = document.getElementById('filterType').value;
            const dateRangeSection = document.getElementById('dateRangeSection');
            
            if (filterType === 'custom') {
                dateRangeSection.classList.add('active');
                // Set default dates for custom range
                const today = new Date();
                const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                document.getElementById('fromDate').value = lastMonth.toISOString().split('T')[0];
                document.getElementById('toDate').value = today.toISOString().split('T')[0];
                updatePeriodInfo('custom', lastMonth.toISOString().split('T')[0], today.toISOString().split('T')[0]);
            } else {
                dateRangeSection.classList.remove('active');
                updatePeriodInfo(filterType);
                fetchSalesData(filterType);
            }
        }

        // Apply custom date filter
        function applyCustomFilter() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                alert('From date cannot be greater than To date');
                return;
            }
            
            updatePeriodInfo('custom', fromDate, toDate);
            fetchSalesData('custom', fromDate, toDate);
        }

        // Format currency
        function formatCurrency(amount) {
            return '₹' + amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Format currency or dash
        function formatCurrencyOrDash(amount) {
            if (amount > 0) {
                return '₹ ' + amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            return '<span class="dash">-</span>';
        }

        // Fetch sales data from server
        function fetchSalesData(filterType, fromDate = null, toDate = null) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            let url = `/api/sales-data?filter=${filterType}`;
            if (filterType === 'custom' && fromDate && toDate) {
                url += `&fromDate=${fromDate}&toDate=${toDate}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDashboard(data);
                    } else {
                        alert('Failed to fetch sales data');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching sales data');
                })
                .finally(() => {
                    loadingOverlay.classList.remove('active');
                });
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update summary boxes
            document.getElementById('totalIncome').textContent = formatCurrency(data.totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(data.totalExpenses);
            document.getElementById('serviceIncome').textContent = formatCurrency(data.serviceIncome);
            document.getElementById('packageIncome').textContent = formatCurrency(data.packageIncome);
            document.getElementById('productIncome').textContent = formatCurrency(data.productIncome);
            document.getElementById('membershipIncome').textContent = formatCurrency(data.membershipIncome);
            
            // Update payment summary table
            document.getElementById('serviceUPI').innerHTML = formatCurrencyOrDash(data.totalUPI);
            document.getElementById('serviceCash').innerHTML = formatCurrencyOrDash(data.totalCash);
            document.getElementById('serviceCard').innerHTML = formatCurrencyOrDash(data.totalCard);
            document.getElementById('serviceTotal').textContent = '₹ ' + data.serviceIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            document.getElementById('packageUPI').innerHTML = formatCurrencyOrDash(data.totalUPIP);
            document.getElementById('packageCash').innerHTML = formatCurrencyOrDash(data.totalCashP);
            document.getElementById('packageCard').innerHTML = formatCurrencyOrDash(data.totalCardP);
            document.getElementById('packageTotal').textContent = '₹ ' + data.packageIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            document.getElementById('productUPI').innerHTML = formatCurrencyOrDash(data.totalUPIPro);
            document.getElementById('productCash').innerHTML = formatCurrencyOrDash(data.totalCashPro);
            document.getElementById('productCard').innerHTML = formatCurrencyOrDash(data.totalCardPro);
            document.getElementById('productTotal').textContent = '₹ ' + data.productIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            document.getElementById('membershipUPI').innerHTML = formatCurrencyOrDash(data.totalUPIM);
            document.getElementById('membershipCash').innerHTML = formatCurrencyOrDash(data.totalCashM);
            document.getElementById('membershipCard').innerHTML = formatCurrencyOrDash(data.totalCardM);
            document.getElementById('membershipTotal').textContent = '₹ ' + data.membershipIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            document.getElementById('totUPI').textContent = '₹ ' + data.totUPI.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totCash').textContent = '₹ ' + data.totCash.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totCard').textContent = '₹ ' + data.totCard.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('grandTotal').textContent = '₹ ' + data.totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Export data function
        function exportData() {
            window.location.href = '/export';
        }
    </script>
    
    <%- include('partials/globalScripts') %>
</body>
</html>
