<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="icon" href="/images/logo 3-square.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Gowun Batang', serif;
            background-color: #D3E4CD;
            min-height: 100vh;
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px 30px;
        }

        /* Header Section */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-header h1 {
            font-size: 28px;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-header h1 i {
            color: #4CAF50;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .period-selector {
            display: flex;
            background: #F5F5DC;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .period-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .period-btn:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        .period-btn.active {
            background: #4CAF50;
            color: white;
        }

        .target-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .target-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
        }

        /* Card Base Styles */
        .card {
            background: #F5F5DC;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-header h3 {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
        }

        .card-header .icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Key Metrics Row - spans full width */
        .metrics-row {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }

        .metric-card {
            background: #F5F5DC;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .metric-card .metric-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .metric-icon.revenue { background: #dcfce7; color: #4CAF50; }
        .metric-icon.expense { background: #fee2e2; color: #ef4444; }
        .metric-icon.profit { background: #dbeafe; color: #3b82f6; }
        .metric-icon.ticket { background: #fef3c7; color: #f59e0b; }
        .metric-icon.discount { background: #ede9fe; color: #8b5cf6; }
        .metric-icon.membership { background: #fce7f3; color: #ec4899; }

        .metric-card .metric-value {
            font-size: 26px;
            font-weight: 700;
            color: #1a202c;
        }

        .metric-card .metric-label {
            font-size: 13px;
            color: #718096;
        }



        /* Revenue Chart - 8 columns */
        .revenue-chart-section {
            grid-column: span 8;
        }

        /* Payment Methods - 4 columns */
        .payment-methods-section {
            grid-column: span 4;
        }

        /* Staff Performance - 6 columns */
        .staff-performance-section {
            grid-column: span 6;
        }

        /* Client Achievement - 3 columns */
        .client-achievement-section {
            grid-column: span 3;
        }

        /* Gender Diversity - 3 columns */
        .gender-section {
            grid-column: span 3;
        }

        /* Monthly Target Chart - 8 columns */
        .monthly-target-section {
            grid-column: span 8;
        }

        /* Trending Services - 4 columns */
        .trending-services-section {
            grid-column: span 4;
        }

        /* Expense Breakdown - 4 columns */
        .expense-breakdown-section {
            grid-column: span 4;
        }

        /* Inventory Alerts - 4 columns */
        .inventory-alerts-section {
            grid-column: span 4;
        }

        /* Membership Stats - 4 columns */
        .membership-stats-section {
            grid-column: span 4;
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container-small {
            position: relative;
            height: 200px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 10px;
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table td {
            padding: 12px 10px;
            font-size: 14px;
            color: #4a5568;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tbody tr:hover {
            background: rgba(76, 175, 80, 0.05);
        }

        /* Staff Table Specifics */
        .staff-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .staff-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4CAF50;
        }

        .staff-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #81c784);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb700); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #b87333); }
        .rank-other { background: #718096; }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81c784);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Alert Items */
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-item .product-name {
            font-weight: 600;
            color: #1a202c;
        }

        .alert-item .stock-count {
            font-size: 13px;
            color: #ef4444;
            font-weight: 600;
        }

        .alert-item .stock-count.warning {
            color: #f59e0b;
        }

        /* Stat Cards in Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            background: white;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-item .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .stat-item.highlight {
            background: linear-gradient(135deg, #4CAF50, #81c784);
        }

        .stat-item.highlight .stat-value,
        .stat-item.highlight .stat-label {
            color: white;
        }

        /* Target Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #F5F5DC;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #1a202c;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #718096;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .btn-save {
            background: #4CAF50;
            color: white;
        }

        .btn-save:hover {
            background: #45a049;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #718096;
        }

        .loading i {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .metrics-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .revenue-chart-section,
            .monthly-target-section {
                grid-column: span 12;
            }

            .payment-methods-section,
            .trending-services-section {
                grid-column: span 6;
            }

            .staff-performance-section {
                grid-column: span 12;
            }

            .client-achievement-section,
            .gender-section {
                grid-column: span 6;
            }

            .expense-breakdown-section,
            .inventory-alerts-section,
            .membership-stats-section {
                grid-column: span 6;
            }
        }

        @media (max-width: 768px) {
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .period-selector {
                flex-wrap: wrap;
            }

            .payment-methods-section,
            .trending-services-section,
            .client-achievement-section,
            .gender-section,
            .expense-breakdown-section,
            .inventory-alerts-section,
            .membership-stats-section {
                grid-column: span 12;
            }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    <%- include('partials/second_navbar') %>
    
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
            <div class="header-controls">
                <div class="period-selector">
                    <button class="period-btn" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn active" data-period="month">This Month</button>
                    <button class="period-btn" data-period="year">This Year</button>
                </div>
                <button class="target-btn" onclick="openTargetModal()">
                    <i class="fas fa-bullseye"></i> Set Monthly Target
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Key Metrics Row -->
            <div class="metrics-row">
                <div class="metric-card">
                    <div class="metric-icon revenue"><i class="fas fa-indian-rupee-sign"></i></div>
                    <div class="metric-value" id="totalRevenue">₹0</div>
                    <div class="metric-label">Total Revenue</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon expense"><i class="fas fa-receipt"></i></div>
                    <div class="metric-value" id="totalExpenses">₹0</div>
                    <div class="metric-label">Total Expenses</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon profit"><i class="fas fa-chart-pie"></i></div>
                    <div class="metric-value" id="netProfit">₹0</div>
                    <div class="metric-label">Net Profit</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon ticket"><i class="fas fa-ticket"></i></div>
                    <div class="metric-value" id="avgTicket">₹0</div>
                    <div class="metric-label">Avg. Ticket Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon discount"><i class="fas fa-percent"></i></div>
                    <div class="metric-value" id="totalDiscount">₹0</div>
                    <div class="metric-label">Discounts Given</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon membership"><i class="fas fa-id-card"></i></div>
                    <div class="metric-value" id="membershipRevenue">₹0</div>
                    <div class="metric-label">Membership Revenue</div>
                </div>
            </div>

            <!-- Revenue Trend Chart -->
            <div class="card revenue-chart-section">
                <div class="card-header">
                    <h3><i class="fas fa-chart-area" style="color: #4CAF50; margin-right: 8px;"></i> Revenue Trend</h3>
                    <div class="icon" style="background: #dcfce7; color: #4CAF50;"><i class="fas fa-arrow-trend-up"></i></div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="card payment-methods-section">
                <div class="card-header">
                    <h3><i class="fas fa-credit-card" style="color: #3b82f6; margin-right: 8px;"></i> Payment Methods</h3>
                </div>
                <div class="chart-container-small">
                    <canvas id="paymentChart"></canvas>
                </div>
                <div id="paymentLegend" style="margin-top: 16px;"></div>
            </div>

            <!-- Staff Performance -->
            <div class="card staff-performance-section">
                <div class="card-header">
                    <h3><i class="fas fa-trophy" style="color: #f59e0b; margin-right: 8px;"></i> Top Stylists Performance</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Stylist</th>
                            <th>Services</th>
                            <th>Revenue</th>
                            <th>Target Progress</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                        <tr><td colspan="5" class="loading"><i class="fas fa-spinner"></i></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Client Achievement -->
            <div class="card client-achievement-section">
                <div class="card-header">
                    <h3><i class="fas fa-users" style="color: #4CAF50; margin-right: 8px;"></i> Client Target</h3>
                </div>
                <div class="chart-container-small">
                    <canvas id="clientDonutChart"></canvas>
                </div>
                <div style="text-align: center; margin-top: 12px;">
                    <span id="achievedClients" style="font-size: 24px; font-weight: 700; color: #4CAF50;">0</span>
                    <span style="color: #718096;"> / </span>
                    <span id="targetClients" style="font-size: 18px; color: #718096;">0</span>
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">Clients Achieved</div>
                </div>
            </div>

            <!-- Gender Diversity -->
            <div class="card gender-section">
                <div class="card-header">
                    <h3><i class="fas fa-venus-mars" style="color: #ec4899; margin-right: 8px;"></i> Gender Split</h3>
                </div>
                <div class="chart-container-small">
                    <canvas id="genderPieChart"></canvas>
                </div>
            </div>

            <!-- Monthly Target Chart -->
            <div class="card monthly-target-section">
                <div class="card-header">
                    <h3><i class="fas fa-bullseye" style="color: #8b5cf6; margin-right: 8px;"></i> Monthly Target Achievement</h3>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Trending Services -->
            <div class="card trending-services-section">
                <div class="card-header">
                    <h3><i class="fas fa-fire" style="color: #ef4444; margin-right: 8px;"></i> Top Services</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Service</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="trendingServicesBody">
                        <tr><td colspan="3" class="loading"><i class="fas fa-spinner"></i></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Expense Breakdown -->
            <div class="card expense-breakdown-section">
                <div class="card-header">
                    <h3><i class="fas fa-wallet" style="color: #ef4444; margin-right: 8px;"></i> Expense Breakdown</h3>
                </div>
                <div class="chart-container-small">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <!-- Inventory Alerts -->
            <div class="card inventory-alerts-section">
                <div class="card-header">
                    <h3><i class="fas fa-box-open" style="color: #f59e0b; margin-right: 8px;"></i> Low Stock Alerts</h3>
                </div>
                <div id="inventoryAlerts">
                    <div class="loading"><i class="fas fa-spinner"></i></div>
                </div>
            </div>

            <!-- Membership Stats -->
            <div class="card membership-stats-section">
                <div class="card-header">
                    <h3><i class="fas fa-id-card" style="color: #ec4899; margin-right: 8px;"></i> Membership Overview</h3>
                </div>
                <div class="stat-grid">
                    <div class="stat-item highlight">
                        <div class="stat-value" id="activeMemberships">0</div>
                        <div class="stat-label">Active Members</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="expiringMemberships">0</div>
                        <div class="stat-label">Expiring Soon</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="newMemberships">0</div>
                        <div class="stat-label">New This Month</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="birthdayOffers">0</div>
                        <div class="stat-label">Birthday Offers Used</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Target Setting Modal -->
    <div class="modal-overlay" id="targetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-bullseye" style="color: #4CAF50; margin-right: 8px;"></i> Set Monthly Target</h2>
                <button class="modal-close" onclick="closeTargetModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="monthlyTarget">Client Target for This Month</label>
                <input type="number" id="monthlyTarget" placeholder="Enter target number of clients">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeTargetModal()">Cancel</button>
                <button class="btn-save" onclick="setMonthlyTarget()">Save Target</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPeriod = 'month';
        let revenueChart, paymentChart, clientDonutChart, genderPieChart, monthlyChart, expenseChart;

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initializePeriodSelector();
            loadAllData();
            
            // Refresh every 30 seconds
            setInterval(loadAllData, 30000);
        });

        // Period Selector
        function initializePeriodSelector() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    loadAllData();
                });
            });
        }

        // Load All Dashboard Data
        async function loadAllData() {
            await Promise.all([
                fetchKeyMetrics(),
                fetchRevenueData(),
                fetchPaymentMethods(),
                fetchStaffPerformance(),
                fetchClientAchievement(),
                fetchGenderData(),
                fetchMonthlyData(),
                fetchTrendingServices(),
                fetchExpenseBreakdown(),
                fetchInventoryAlerts(),
                fetchMembershipStats()
            ]);
        }

        // Format currency
        function formatCurrency(amount) {
            return '₹' + amount.toLocaleString('en-IN');
        }

        // Fetch Key Metrics
        async function fetchKeyMetrics() {
            try {
                const response = await fetch(`/api/analytics/metrics?period=${currentPeriod}`);
                const data = await response.json();
                
                document.getElementById('totalRevenue').textContent = formatCurrency(data.revenue || 0);
                document.getElementById('totalExpenses').textContent = formatCurrency(data.expenses || 0);
                document.getElementById('netProfit').textContent = formatCurrency(data.profit || 0);
                document.getElementById('avgTicket').textContent = formatCurrency(data.avgTicket || 0);
                document.getElementById('totalDiscount').textContent = formatCurrency(data.discount || 0);
                document.getElementById('membershipRevenue').textContent = formatCurrency(data.membershipRevenue || 0);
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // Fetch Revenue Data
        async function fetchRevenueData() {
            try {
                const response = await fetch(`/api/analytics/revenue-trend?period=${currentPeriod}`);
                const data = await response.json();
                
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                if (revenueChart) revenueChart.destroy();
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || [],
                        datasets: [{
                            label: 'Revenue',
                            data: data.values || [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: {
                                    callback: value => formatCurrency(value)
                                }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching revenue data:', error);
            }
        }

        // Fetch Payment Methods
        async function fetchPaymentMethods() {
            try {
                const response = await fetch(`/api/analytics/payment-methods?period=${currentPeriod}`);
                const data = await response.json();
                
                const ctx = document.getElementById('paymentChart').getContext('2d');
                
                if (paymentChart) paymentChart.destroy();
                
                paymentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['UPI', 'Cash', 'Card'],
                        datasets: [{
                            data: [data.upi || 0, data.cash || 0, data.card || 0],
                            backgroundColor: ['#8b5cf6', '#4CAF50', '#3b82f6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 12 },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total > 0 ? Math.round((value / total) * 100) + '%' : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });

                // Update legend
                const legend = document.getElementById('paymentLegend');
                const total = (data.upi || 0) + (data.cash || 0) + (data.card || 0);
                legend.innerHTML = `
                    <div style="display: flex; justify-content: space-around; font-size: 13px;">
                        <div><span style="display: inline-block; width: 12px; height: 12px; background: #8b5cf6; border-radius: 3px; margin-right: 6px;"></span>UPI: ${formatCurrency(data.upi || 0)}</div>
                        <div><span style="display: inline-block; width: 12px; height: 12px; background: #4CAF50; border-radius: 3px; margin-right: 6px;"></span>Cash: ${formatCurrency(data.cash || 0)}</div>
                        <div><span style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; border-radius: 3px; margin-right: 6px;"></span>Card: ${formatCurrency(data.card || 0)}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching payment methods:', error);
            }
        }

        // Fetch Staff Performance
        async function fetchStaffPerformance() {
            try {
                const response = await fetch(`/api/analytics/staff-performance?period=${currentPeriod}`);
                const data = await response.json();
                
                const tbody = document.getElementById('staffTableBody');
                
                if (!data.staff || data.staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No data available</td></tr>';
                    return;
                }

                tbody.innerHTML = data.staff.slice(0, 5).map((s, i) => `
                    <tr>
                        <td><span class="rank-badge rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</span></td>
                        <td>
                            <div class="staff-row">
                                ${s.photo ? 
                                    `<img src="${s.photo}" class="staff-avatar" alt="${s.name}">` : 
                                    `<div class="staff-avatar-placeholder">${s.name.charAt(0)}</div>`
                                }
                                <span>${s.name}</span>
                            </div>
                        </td>
                        <td>${s.services || 0}</td>
                        <td style="font-weight: 600; color: #4CAF50;">${formatCurrency(s.revenue || 0)}</td>
                        <td style="width: 150px;">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(s.progress || 0, 100)}%"></div>
                            </div>
                            <div style="font-size: 11px; color: #718096; margin-top: 4px;">${s.progress || 0}%</div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error fetching staff performance:', error);
                document.getElementById('staffTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Error loading data</td></tr>';
            }
        }

        // Fetch Client Achievement (existing API)
        async function fetchClientAchievement() {
            try {
                const response = await fetch('/current-month-data');
                const data = await response.json();

                const achieved = data.achieved || 0;
                const target = data.target || 0;
                const remaining = Math.max(target - achieved, 0);

                document.getElementById('achievedClients').textContent = achieved;
                document.getElementById('targetClients').textContent = target;

                const ctx = document.getElementById('clientDonutChart').getContext('2d');
                
                if (clientDonutChart) clientDonutChart.destroy();
                
                clientDonutChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Achieved', 'Remaining'],
                        datasets: [{
                            data: [achieved, remaining],
                            backgroundColor: ['#4CAF50', '#e2e8f0'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        circumference: 180,
                        rotation: -90,
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: (ctx) => ctx.dataIndex === 0 ? '#fff' : '#718096',
                                font: { weight: 'bold', size: 14 },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total > 0 ? Math.round((value / total) * 100) + '%' : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error fetching client achievement:', error);
            }
        }

        // Fetch Gender Data (existing API)
        async function fetchGenderData() {
            try {
                const response = await fetch('/gender-data');
                const data = await response.json();

                const ctx = document.getElementById('genderPieChart').getContext('2d');
                
                if (genderPieChart) genderPieChart.destroy();
                
                genderPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Male', 'Female', 'Others'],
                        datasets: [{
                            data: [data.maleCount || 0, data.femaleCount || 0, data.othersCount || 0],
                            backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { boxWidth: 12, padding: 15 }
                            },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 12 },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total > 0 ? Math.round((value / total) * 100) + '%' : '';
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error fetching gender data:', error);
            }
        }

        // Fetch Monthly Data (existing API)
        async function fetchMonthlyData() {
            try {
                const response = await fetch('/monthly-data');
                const data = await response.json();
                
                // Include year in the month labels (e.g., "Jan '25", "Feb '25")
                const months = data.map(entry => `${entry.month} '${String(entry.year).slice(-2)}`);
                const targets = data.map(entry => entry.target);
                const achievements = data.map(entry => entry.achieved);

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                if (monthlyChart) monthlyChart.destroy();
                
                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Achieved',
                                data: achievements,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Target',
                                data: targets,
                                borderColor: '#8b5cf6',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { boxWidth: 12 }
                            },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching monthly data:', error);
            }
        }

        // Fetch Trending Services (existing API)
        async function fetchTrendingServices() {
            try {
                const response = await fetch('/trending-services');
                const data = await response.json();
                
                const tbody = document.getElementById('trendingServicesBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #718096;">No data available</td></tr>';
                    return;
                }

                tbody.innerHTML = data.slice(0, 8).map((service, index) => `
                    <tr>
                        <td><span class="rank-badge rank-${index < 3 ? index + 1 : 'other'}">${index + 1}</span></td>
                        <td>${service.name}</td>
                        <td style="font-weight: 600;">${service.utilization}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error fetching trending services:', error);
            }
        }

        // Fetch Expense Breakdown
        async function fetchExpenseBreakdown() {
            try {
                const response = await fetch(`/api/analytics/expense-breakdown?period=${currentPeriod}`);
                const data = await response.json();
                
                const ctx = document.getElementById('expenseChart').getContext('2d');
                
                if (expenseChart) expenseChart.destroy();
                
                const categories = data.categories || [];
                const amounts = data.amounts || [];
                
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: amounts,
                            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#4CAF50'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { boxWidth: 10, padding: 10, font: { size: 11 } }
                            },
                            datalabels: { display: false }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching expense breakdown:', error);
            }
        }

        // Fetch Inventory Alerts
        async function fetchInventoryAlerts() {
            try {
                const response = await fetch('/api/analytics/inventory-alerts');
                const data = await response.json();
                
                const container = document.getElementById('inventoryAlerts');
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #4CAF50; padding: 40px;"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i><br>All stock levels healthy!</div>';
                    return;
                }

                container.innerHTML = data.items.slice(0, 5).map(item => `
                    <div class="alert-item">
                        <div>
                            <div class="product-name">${item.name}</div>
                            <div style="font-size: 12px; color: #718096;">Min: ${item.minimum}</div>
                        </div>
                        <div class="stock-count ${item.available > 5 ? 'warning' : ''}">
                            <i class="fas fa-exclamation-triangle"></i> ${item.available} left
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error fetching inventory alerts:', error);
                document.getElementById('inventoryAlerts').innerHTML = '<div style="text-align: center; color: #718096;">Could not load alerts</div>';
            }
        }

        // Fetch Membership Stats
        async function fetchMembershipStats() {
            try {
                const response = await fetch('/api/analytics/membership-stats');
                const data = await response.json();
                
                document.getElementById('activeMemberships').textContent = data.active || 0;
                document.getElementById('expiringMemberships').textContent = data.expiring || 0;
                document.getElementById('newMemberships').textContent = data.newThisMonth || 0;
                document.getElementById('birthdayOffers').textContent = data.birthdayOffersUsed || 0;
            } catch (error) {
                console.error('Error fetching membership stats:', error);
            }
        }

        // Target Modal Functions
        function openTargetModal() {
            document.getElementById('targetModal').classList.add('active');
        }

        function closeTargetModal() {
            document.getElementById('targetModal').classList.remove('active');
        }

        // Set Monthly Target (existing functionality)
        async function setMonthlyTarget() {
            const targetValue = document.getElementById('monthlyTarget').value;

            if (!targetValue) {
                alert('Please enter a target value.');
                return;
            }

            try {
                const response = await fetch('/set-monthly-target', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: targetValue })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeTargetModal();
                    fetchClientAchievement();
                    fetchMonthlyData();
                } else {
                    alert(result.message || 'Failed to set target.');
                }
            } catch (error) {
                console.error('Error setting monthly target:', error);
                alert('Error setting target. Please try again.');
            }
        }

        // Close modal on outside click
        document.getElementById('targetModal').addEventListener('click', (e) => {
            if (e.target.id === 'targetModal') {
                closeTargetModal();
            }
        });
    </script>
    <%- include('partials/globalScripts') %>
</body>
</html>
